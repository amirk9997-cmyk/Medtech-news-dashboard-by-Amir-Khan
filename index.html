<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unified Medical Device News</title>
  <style>
    :root {
      --primary: #007bff;
      --secondary: #ddd;
      --text-dark: #333;
      --text-light: #555;
      --bg-light: #f4f4f9;
      --chip-bg: #eef3ff;
    }
    body { font-family: Arial, sans-serif; margin:0; background: var(--bg-light); color: var(--text-dark); }
    .container { max-width: 1280px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; margin: 0 0 12px; }
    .subtitle { text-align:center; color: var(--text-light); margin-bottom: 18px; font-size: 14px; }

    .tabs { display:flex; justify-content:center; gap:12px; margin-bottom: 12px; flex-wrap:wrap; }
    .tab { border:none; border-radius: 6px; padding:8px 12px; background: var(--secondary); cursor:pointer; }
    .tab.active { background: var(--primary); color:#fff; }

    .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin: 12px 0 18px; }
    .controls input, .controls select { padding:8px; border:1px solid #ccc; border-radius:6px; min-width: 200px; }
    .controls .chipbar { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .chip { background: var(--chip-bg); border: 1px solid #cfe1ff; border-radius: 999px; padding:4px 10px; font-size: 12px; cursor:pointer; }
    .chip.active { background: var(--primary); color:#fff; border-color: var(--primary); }

    .meta { text-align:center; color: var(--text-light); font-size: 12px; margin-bottom: 10px; }

    .list { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:10px; padding:14px; display:flex; flex-direction:column; gap:10px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
    .row { display:flex; gap:12px; align-items:flex-start; }
    .thumb { width:120px; height:80px; border-radius:6px; object-fit:cover; background:#f2f2f2; flex:0 0 auto; }
    .title { font-size:16px; margin:0; line-height:1.3; }
    .desc { font-size:13px; color: var(--text-light); margin:0; }
    .metaRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .source { font-size:12px; color:#666; }
    .badges { display:flex; gap:6px; flex-wrap:wrap; }
    .badge { font-size:11px; background:#f6f7f9; border:1px solid #e1e4e8; border-radius: 999px; padding: 3px 8px; }
    .link { color: var(--primary); text-decoration:none; font-size: 13px; }
    .link:hover { text-decoration: underline; }

    .actions { display:flex; justify-content:center; gap:10px; margin: 8px 0 12px; }
    .btn { background: var(--primary); color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; font-size:14px; }
    .btn.secondary { background:#6c757d; }
    .empty { text-align:center; color: var(--text-light); padding: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Unified Medical Device News</h1>
    <div class="subtitle">Aggregating multiple medtech and healthcare news feeds into one searchable, filterable view</div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-section="global">Global</button>
      <button class="tab" data-section="indian">Indian</button>
    </div>

    <!-- Controls -->
    <div class="controls">
      <input type="text" id="searchBox" placeholder="Search title/description…" />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="AI">AI</option>
        <option value="M&A">M&A</option>
        <option value="Regulatory">Regulatory</option>
        <option value="Safety">Safety</option>
        <option value="Funding">Funding</option>
        <option value="RSS">From Feed</option>
      </select>
      <select id="sourceFilter">
        <option value="">All Sources</option>
      </select>
    </div>

    <!-- Quick chips for common medtech topics -->
    <div class="controls chipbar" id="chipbar">
      <span class="chip" data-chip="medtronic">Medtronic</span>
      <span class="chip" data-chip="philips">Philips</span>
      <span class="chip" data-chip="boston scientific">Boston Scientific</span>
      <span class="chip" data-chip="abbott">Abbott</span>
      <span class="chip" data-chip="ai">AI</span>
      <span class="chip" data-chip="regulatory">Regulatory</span>
      <span class="chip" data-chip="recall">Recall</span>
      <span class="chip" data-chip="ipo">IPO</span>
      <span class="chip" data-chip="m&a">M&A</span>
      <span class="chip" data-chip="funding">Funding</span>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn" id="refreshNow">Refresh Feeds Now</button>
      <button class="btn secondary" id="clearFilters">Clear Filters</button>
    </div>

    <!-- Last updated -->
    <div class="meta">
      <span id="lastUpdatedGlobal">Global last updated: —</span> | <span id="lastUpdatedIndian">Indian last updated: —</span>
    </div>

    <!-- Lists -->
    <div id="global" class="list"></div>
    <div id="indian" class="list" style="display:none;"></div>
  </div>

  <script>
    // ------------- Configuration -------------
    // Use a CORS-friendly RSS proxy (AllOrigins). If rate-limited, consider hosting your own proxy or API Gateway with CORS. [CORS background]
    // Sources: MedTech Dive; Economic Times Health categories; extend as needed.
    // Add/remove feeds below. Items are mapped to Global vs Indian sections.

    const RSS_PROXY = (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&ts=${Date.now()}`;

    const FEEDS = {
      global: [
        { name: "MedTech Dive", url: "https://www.medtechdive.com/feeds/news/" }, // Global medtech focus
      ],
      indian: [
        // Economic Times Health verticals, including Medical Devices
        { name: "ET Health - Medical Devices", url: "https://health.economictimes.indiatimes.com/rss/medical-devices" },
        { name: "ET Health - Diagnostics", url: "https://health.economictimes.indiatimes.com/rss/diagnostics" },
        { name: "ET Health - Policy", url: "https://health.economictimes.indiatimes.com/rss/policy" },
        { name: "ET Health - Industry", url: "https://health.economictimes.indiatimes.com/rss/industry" },
        { name: "ET Health - Health IT", url: "https://health.economictimes.indiatimes.com/rss/health-it" },
        { name: "ET Health - Top Stories", url: "https://health.economictimes.indiatimes.com/rss/topstories" },
        { name: "ET Health - Recent", url: "https://health.economictimes.indiatimes.com/rss/recentstories" },
        // Add more ET categories if desired
      ],
    };

    const PLACEHOLDER_IMG = "https://via.placeholder.com/400x220?text=News";

    // ------------- State -------------
    let items = { global: [], indian: [] };
    let activeSection = "global";

    // ------------- Utilities -------------
    function textClean(s) {
      if (!s) return "";
      // Strip HTML tags from descriptions
      const div = document.createElement("div");
      div.innerHTML = s;
      return div.textContent || div.innerText || "";
    }

    function parsePubDate(dateStr) {
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? 0 : d.getTime();
    }

    function dedupeByLink(arr) {
      const seen = new Set();
      const out = [];
      for (const it of arr) {
        const key = (it.link || it.title || "").trim();
        if (!seen.has(key)) { seen.add(key); out.push(it); }
      }
      return out;
    }

    function updateLastUpdated(section) {
      const el = section === "global" ? document.getElementById("lastUpdatedGlobal") : document.getElementById("lastUpdatedIndian");
      el.textContent = `${section.toUpperCase() + section.slice(1)} last updated: ${new Date().toLocaleString()}`;
    }

    function categoryFromText(title, description) {
      const t = (title + " " + description).toLowerCase();
      if (t.includes("recall") || t.includes("safety")) return "Safety";
      if (t.includes("fda") || t.includes("dcgi") || t.includes("regulator") || t.includes("policy")) return "Regulatory";
      if (t.includes("ai") || t.includes("artificial intelligence") || t.includes("machine learning")) return "AI";
      if (t.includes("acquire") || t.includes("acquisition") || t.includes("merger") || t.includes("m&a")) return "M&A";
      if (t.includes("funding") || t.includes("raises") || t.includes("investment") || t.includes("ipo")) return "Funding";
      return "RSS";
    }

    // ------------- Fetch & Parse -------------
    async function fetchFeed(url) {
      const res = await fetch(RSS_PROXY(url));
      const data = await res.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, "text/xml");
      return xml;
    }

    function extractImageFromItem(item) {
      // Try <media:content>, <enclosure>, or img inside description
      const media = item.querySelector("media\\:content, content");
      if (media?.getAttribute) {
        const u = media.getAttribute("url") || media.getAttribute("src");
        if (u) return u;
      }
      const enclosure = item.querySelector("enclosure");
      if (enclosure?.getAttribute("url")) return enclosure.getAttribute("url");
      const desc = item.querySelector("description")?.textContent || "";
      const match = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
      if (match) return match[12];
      return PLACEHOLDER_IMG;
    }

    function mapRssItems(xml, sourceName) {
      const out = [];
      const items = xml.querySelectorAll("item");
      if (items.length) {
        items.forEach(it => {
          const title = it.querySelector("title")?.textContent?.trim() || "Untitled";
          const link = it.querySelector("link")?.textContent?.trim() || "#";
          const description = textClean(it.querySelector("description")?.textContent || it.querySelector("content\\:encoded")?.textContent || "");
          const pubDate = it.querySelector("pubDate")?.textContent || it.querySelector("dc\\:date")?.textContent || "";
          const image = extractImageFromItem(it);
          out.push({ title, link, description, source: sourceName, pubDate, ts: parsePubDate(pubDate), image, category: categoryFromText(title, description) });
        });
      } else {
        // Atom support
        const entries = xml.querySelectorAll("entry");
        entries.forEach(en => {
          const title = en.querySelector("title")?.textContent?.trim() || "Untitled";
          const link = en.querySelector("link")?.getAttribute("href") || "#";
          const description = textClean(en.querySelector("summary")?.textContent || en.querySelector("content")?.textContent || "");
          const pubDate = en.querySelector("updated")?.textContent || en.querySelector("published")?.textContent || "";
          const image = PLACEHOLDER_IMG;
          out.push({ title, link, description, source: sourceName, pubDate, ts: parsePubDate(pubDate), image, category: categoryFromText(title, description) });
        });
      }
      return out;
    }

    async function loadSection(section) {
      // Fetch all feeds for the section and merge
      const feeds = FEEDS[section];
      const all = [];
      for (const f of feeds) {
        try {
          const xml = await fetchFeed(f.url);
          const mapped = mapRssItems(xml, f.name);
          all.push(...mapped);
        } catch (e) {
          console.error("Feed failed:", f.name, f.url, e);
        }
      }
      // Sort by time desc, de-duplicate by link/title
      const merged = dedupeByLink(all).sort((a,b) => (b.ts || 0) - (a.ts || 0));
      items[section] = merged;
      updateLastUpdated(section);
      render();
      populateSourceFilter(); // update unique sources in filter
    }

    async function refreshAll() {
      await Promise.all([loadSection("global"), loadSection("indian")]);
    }

    // ------------- Rendering & Filters -------------
    function populateSourceFilter() {
      const sel = document.getElementById("sourceFilter");
      const cur = sel.value;
      const set = new Set([...items.global, ...items.indian].map(i => i.source));
      const options = ['<option value="">All Sources</option>', ...Array.from(set).sort().map(s => `<option value="${s}">${s}</option>`)].join("");
      sel.innerHTML = options;
      if (cur) sel.value = cur;
    }

    function currentFilters() {
      const q = document.getElementById("searchBox").value.trim().toLowerCase();
      const cat = document.getElementById("categoryFilter").value;
      const src = document.getElementById("sourceFilter").value;
      const chips = Array.from(document.querySelectorAll(".chip.active")).map(c => c.dataset.chip);
      return { q, cat, src, chips };
    }

    function applyFilters(arr) {
      const { q, cat, src, chips } = currentFilters();
      return arr.filter(it => {
        const hay = (it.title + " " + it.description + " " + it.source).toLowerCase();
        const matchesQ = !q || hay.includes(q);
        const matchesCat = !cat || it.category === cat;
        const matchesSrc = !src || it.source === src;
        const matchesChips = !chips.length || chips.every(ch => hay.includes(ch));
        return matchesQ && matchesCat && matchesSrc && matchesChips;
      });
    }

    function renderList(section) {
      const node = document.getElementById(section);
      node.innerHTML = "";
      const data = applyFilters(items[section]);
      if (!data.length) {
        node.innerHTML = `<div class="empty">No items match current filters.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      data.forEach(it => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <img class="thumb" src="${it.image}" alt="thumbnail" loading="lazy" />
            <div>
              <h3 class="title">${it.title}</h3>
              <p class="desc">${it.description.slice(0, 240)}${it.description.length > 240 ? "…" : ""}</p>
            </div>
          </div>
          <div class="metaRow">
            <span class="source">${it.source} • ${it.pubDate ? new Date(it.pubDate).toLocaleString() : "Unknown date"}</span>
            <div class="badges">
              <span class="badge">${it.category}</span>
            </div>
          </div>
          <div>
            <a class="link" href="${it.link}" target="_blank" rel="noopener">Read more</a>
          </div>
        `;
        frag.appendChild(card);
      });
      node.appendChild(frag);
    }

    function render() {
      renderList("global");
      renderList("indian");
    }

    function setActiveSection(section) {
      activeSection = section;
      document.querySelectorAll(".list").forEach(el => el.style.display = "none");
      document.getElementById(section).style.display = "grid";
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.section === section));
    }

    // ------------- Events -------------
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("tab")) {
        setActiveSection(e.target.dataset.section);
      }
      if (e.target.classList.contains("chip")) {
        e.target.classList.toggle("active");
        render();
      }
    });

    document.getElementById("searchBox").addEventListener("input", render);
    document.getElementById("categoryFilter").addEventListener("change", render);
    document.getElementById("sourceFilter").addEventListener("change", render);
    document.getElementById("clearFilters").addEventListener("click", () => {
      document.getElementById("searchBox").value = "";
      document.getElementById("categoryFilter").value = "";
      document.getElementById("sourceFilter").value = "";
      document.querySelectorAll(".chip.active").forEach(c => c.classList.remove("active"));
      render();
    });
    document.getElementById("refreshNow").addEventListener("click", refreshAll);

    // ------------- Init & Auto-refresh -------------
    (async function init() {
      setActiveSection("global");
      await refreshAll();
      // Auto-refresh every 20 minutes
      setInterval(refreshAll, 20 * 60 * 1000);
    })();
  </script>
</body>
</html>
